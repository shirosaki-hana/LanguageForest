# =============================================================================
# TemplateForest Docker Compose Configuration
# =============================================================================
# Usage:
# docker compose up -d        # Start services (background)
# docker compose up --build   # Rebuild images and start
# docker compose down         # Stop and delete services
# docker compose logs -f      # View logs
# =============================================================================

services:
  templateforest:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: templateforest
    restart: unless-stopped
    ports:
      - "${PORT:-4001}:4001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - HOST=0.0.0.0
      - PORT=4001
      - DATABASE_URL_SQLITE=file:/app/data/templateforest.db
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:4001}
      - SESSION_TTL=${SESSION_TTL:-24h}
      - SESSION_COOKIE=${SESSION_COOKIE:-session}
      - RATELIMIT_MAX=${RATELIMIT_MAX:-100}
      - RATELIMIT_WINDOWMS=${RATELIMIT_WINDOWMS:-10s}
    volumes:
      # SQLite Database Persistence
      - templateforest-data:/app/data
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:4001/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# -----------------------------------------------------------------------------
# Named Volumes
# -----------------------------------------------------------------------------
volumes:
  templateforest-data:
    name: templateforest-data
